openapi: 3.0.0
info:
  title: Cloud Storage Service API
  description: |
    # Cloud Storage Service

    基于Go语言和Gin框架构建的网盘文件存储服务，提供完备的RESTful API接口。

    ## 功能特性

    - 用户认证和授权
    - 文件上传和下载
    - 文件管理和操作
    - 文件夹管理
    - 文件分享
    - 回收站功能
    - 文件版本控制

    ## 认证

    使用Bearer Token进行认证。在登录成功后，将获得的访问令牌添加到请求头中：

    ```
    Authorization: Bearer <access_token>
    ```

  version: 1.0.0
  contact:
    name: Cloud Storage Team
    email: support@cloud-storage.example.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8080/api/v1
    description: 本地开发服务器
  - url: https://api.cloud-storage.example.com/api/v1
    description: 生产服务器

tags:
  - name: 认证
    description: 用户认证和授权相关接口
  - name: 文件
    description: 文件上传、下载和管理接口
  - name: 目录
    description: 目录管理接口
  - name: 分享
    description: 文件分享接口
  - name: 回收站
    description: 回收站管理接口
  - name: 系统
    description: 系统管理和监控接口

paths:
  # 认证相关
  /auth/register:
    post:
      tags: [认证]
      summary: 用户注册
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserRegisterRequest'
      responses:
        '201':
          description: 注册成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: 请求参数错误
        '409':
          description: 用户名或邮箱已存在
        '500':
          description: 服务器内部错误

  /auth/login:
    post:
      tags: [认证]
      summary: 用户登录
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserLoginRequest'
      responses:
        '200':
          description: 登录成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: 用户名或密码错误
        '403':
          description: 账户被禁用
        '500':
          description: 服务器内部错误

  /auth/logout:
    post:
      tags: [认证]
      summary: 用户登出
      security:
        - BearerAuth: []
      responses:
        '200':
          description: 登出成功
        '401':
          description: 未认证
        '500':
          description: 服务器内部错误

  /auth/refresh:
    post:
      tags: [认证]
      summary: 刷新令牌
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshTokenRequest'
      responses:
        '200':
          description: 令牌刷新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RefreshTokenResponse'
        '401':
          description: 刷新令牌无效
        '500':
          description: 服务器内部错误

  /auth/profile:
    get:
      tags: [认证]
      summary: 获取用户资料
      security:
        - BearerAuth: []
      responses:
        '200':
          description: 获取成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '401':
          description: 未认证
        '500':
          description: 服务器内部错误

  # 文件相关
  /files:
    get:
      tags: [文件]
      summary: 获取文件列表
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ParentID'
        - $ref: '#/components/parameters/Page'
        - $ref: '#/components/parameters/PageSize'
        - $ref: '#/components/parameters/SortBy'
        - $ref: '#/components/parameters/SortOrder'
      responses:
        '200':
          description: 获取成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileListResponse'
        '401':
          description: 未认证
        '500':
          description: 服务器内部错误

    post:
      tags: [文件, 目录]
      summary: 创建文件或目录
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FileCreateRequest'
      responses:
        '201':
          description: 创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileResponse'
        '400':
          description: 请求参数错误
        '401':
          description: 未认证
        '409':
          description: 文件或目录已存在
        '500':
          description: 服务器内部错误

  /files/{id}:
    get:
      tags: [文件]
      summary: 获取文件信息
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/FileID'
      responses:
        '200':
          description: 获取成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileResponse'
        '401':
          description: 未认证
        '403':
          description: 权限不足
        '404':
          description: 文件不存在
        '500':
          description: 服务器内部错误

    put:
      tags: [文件]
      summary: 更新文件信息
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/FileID'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FileUpdateRequest'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileResponse'
        '400':
          description: 请求参数错误
        '401':
          description: 未认证
        '403':
          description: 权限不足
        '404':
          description: 文件不存在
        '409':
          description: 文件名冲突
        '500':
          description: 服务器内部错误

    delete:
      tags: [文件]
      summary: 删除文件
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/FileID'
        - name: permanent
          in: query
          description: 是否永久删除
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: 删除成功
        '401':
          description: 未认证
        '403':
          description: 权限不足
        '404':
          description: 文件不存在
        '500':
          description: 服务器内部错误

  /files/{id}/download:
    get:
      tags: [文件]
      summary: 下载文件
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/FileID'
      responses:
        '200':
          description: 文件下载
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '401':
          description: 未认证
        '403':
          description: 权限不足
        '404':
          description: 文件不存在
        '500':
          description: 服务器内部错误

  /upload:
    post:
      tags: [文件]
      summary: 上传文件
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                  description: 上传的文件
                parent_id:
                  type: string
                  format: uuid
                  description: 父目录ID
                is_public:
                  type: boolean
                  description: 是否公开
                  default: false
                override:
                  type: boolean
                  description: 是否覆盖同名文件
                  default: false
      responses:
        '201':
          description: 上传成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileResponse'
        '400':
          description: 请求参数错误
        '401':
          description: 未认证
        '403':
          description: 存储配额不足
        '409':
          description: 文件已存在
        '413':
          description: 文件太大
        '500':
          description: 服务器内部错误

  # 系统相关
  /health:
    get:
      tags: [系统]
      summary: 健康检查
      responses:
        '200':
          description: 服务正常
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  time:
                    type: integer
                    example: 1640995200

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    FileID:
      name: id
      in: path
      required: true
      description: 文件ID
      schema:
        type: string
        format: uuid

    ParentID:
      name: parent_id
      in: query
      required: false
      description: 父目录ID
      schema:
        type: string
        format: uuid

    Page:
      name: page
      in: query
      required: false
      description: 页码
      schema:
        type: integer
        minimum: 1
        default: 1

    PageSize:
      name: page_size
      in: query
      required: false
      description: 每页大小
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20

    SortBy:
      name: sort_by
      in: query
      required: false
      description: 排序字段
      schema:
        type: string
        enum: [name, size, created_at, updated_at]
        default: name

    SortOrder:
      name: sort_order
      in: query
      required: false
      description: 排序顺序
      schema:
        type: string
        enum: [asc, desc]
        default: asc

  schemas:
    # 认证相关
    UserRegisterRequest:
      type: object
      required: [username, email, password]
      properties:
        username:
          type: string
          minLength: 3
          maxLength: 50
          example: "john_doe"
        email:
          type: string
          format: email
          example: "john@example.com"
        password:
          type: string
          minLength: 8
          example: "password123"
        role:
          type: string
          enum: [user, admin]
          default: user
          example: "user"

    UserLoginRequest:
      type: object
      required: [username, password]
      properties:
        username:
          type: string
          example: "john_doe"
        password:
          type: string
          example: "password123"

    AuthResponse:
      type: object
      properties:
        message:
          type: string
          example: "login successful"
        user:
          $ref: '#/components/schemas/UserResponse'
        tokens:
          type: object
          properties:
            access_token:
              type: string
              example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
            refresh_token:
              type: string
              example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
            token_type:
              type: string
              example: "Bearer"
            expires_in:
              type: integer
              example: 3600

    RefreshTokenRequest:
      type: object
      required: [refresh_token]
      properties:
        refresh_token:
          type: string
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."

    RefreshTokenResponse:
      type: object
      properties:
        message:
          type: string
          example: "token refreshed successfully"
        tokens:
          $ref: '#/components/schemas/AuthResponse/properties/tokens'

    # 用户相关
    UserResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "123e4567-e89b-12d3-a456-426614174000"
        username:
          type: string
          example: "john_doe"
        email:
          type: string
          format: email
          example: "john@example.com"
        role:
          type: string
          enum: [user, admin]
          example: "user"
        storage_quota:
          type: integer
          example: 10737418240
        used_storage:
          type: integer
          example: 104857600
        is_active:
          type: boolean
          example: true
        last_login_at:
          type: string
          format: date-time
          nullable: true
          example: "2023-12-31T23:59:59Z"
        created_at:
          type: string
          format: date-time
          example: "2023-01-01T00:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2023-01-01T00:00:00Z"

    # 文件相关
    FileCreateRequest:
      type: object
      required: [name, type]
      properties:
        name:
          type: string
          example: "document.pdf"
        parent_id:
          type: string
          format: uuid
          nullable: true
          example: "123e4567-e89b-12d3-a456-426614174000"
        type:
          type: string
          enum: [file, directory]
          example: "file"
        is_public:
          type: boolean
          default: false
          example: false

    FileUpdateRequest:
      type: object
      properties:
        name:
          type: string
          example: "renamed.pdf"
        parent_id:
          type: string
          format: uuid
          nullable: true
          example: "123e4567-e89b-12d3-a456-426614174000"
        is_public:
          type: boolean
          example: true

    FileResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "123e4567-e89b-12d3-a456-426614174000"
        name:
          type: string
          example: "document.pdf"
        path:
          type: string
          example: "/documents/document.pdf"
        size:
          type: integer
          example: 1048576
        mime_type:
          type: string
          example: "application/pdf"
        type:
          type: string
          enum: [file, directory]
          example: "file"
        is_public:
          type: boolean
          example: false
        share_token:
          type: string
          nullable: true
          example: "abc123def456ghi789"
        version:
          type: integer
          example: 1
        user_id:
          type: string
          format: uuid
          example: "123e4567-e89b-12d3-a456-426614174000"
        parent_id:
          type: string
          format: uuid
          nullable: true
          example: "123e4567-e89b-12d3-a456-426614174000"
        created_at:
          type: string
          format: date-time
          example: "2023-01-01T00:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2023-01-01T00:00:00Z"

    FileListResponse:
      type: object
      properties:
        files:
          type: array
          items:
            $ref: '#/components/schemas/FileResponse'
        total:
          type: integer
          example: 100
        page:
          type: integer
          example: 1
        size:
          type: integer
          example: 20

    # 错误响应
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          example: "Error message"
        details:
          type: object
          nullable: true
          additionalProperties: true